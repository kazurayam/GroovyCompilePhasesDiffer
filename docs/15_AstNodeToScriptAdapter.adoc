== AstNodeToScriptAdapter

One day, I asked a question to Copilot:

[quote]
____
In Groovy, I want to unparse an AST into source. How can I do it?
____

Copilot replied as follows:

[quote]
____
‚ú® If you're working with Groovy‚Äôs abstract syntax tree (AST) and want to turn it back into source code (a process often called ‚Äúunparsing‚Äù), you‚Äôve got a few tools at your disposal‚Äîthough Groovy doesn‚Äôt have a built-in one-size-fits-all solution for this.

Here‚Äôs how you can go about it:

üõ† Option 1:

Use Groovy‚Äôs AstNodeToScriptAdapter
Groovy includes an adapter class that converts AST nodes back into Groovy source code. It‚Äôs found in the org.codehaus.groovy.tools.ast package.

[source, groovy]
----
import org.codehaus.groovy.ast.ClassNode
import org.codehaus.groovy.control.CompilationUnit
import org.codehaus.groovy.tools.ast.AstNodeToScriptAdapter

def sourceCode = '''
class HelloWorld {
    static void main(String[] args) {
        println "Hello, Groovy!"
    }
}
'''

def cu = new CompilationUnit()
cu.addSource('script.groovy', sourceCode)
cu.compile()

def classes = cu.ast.getClasses()
def adapter = new AstNodeToScriptAdapter()

classes.each { ClassNode classNode ->
    def reconstructed = adapter.print(classNode)
    println reconstructed
}
----

üß© Notes

You‚Äôll need access to the Groovy internals, so make sure the relevant modules are available in your classpath (like groovy-ant or groovy-tools depending on your version).

The adapter won‚Äôt always preserve original formatting or comments, but it does a solid job reconstructing syntactically correct Groovy code.
____

I asked Copilot one more question:

[quote]
____
What use of groovy.console.ui.AstNodeToScriptAdapter class?
____

Copilot replied as follows:

[quote]
____
The groovy.console.ui.AstNodeToScriptAdapter class is a utility in the Groovy Console that serves a pretty neat purpose: it compiles Groovy source code to a specific phase of the compiler, then decompiles it back into readable Groovy source.

Here‚Äôs how it‚Äôs typically used:

üß† Primary Purpose

- AST Visualization: It powers the AST (Abstract Syntax Tree) Browser in the Groovy Console, helping developers inspect how Groovy transforms code during compilation.

- Debugging & Learning Tool: Useful for understanding AST transformations, especially when writing custom AST transforms.

üîß Key Method

[source]
----
String compileToScript(String script, int compilePhase, ClassLoader classLoader, boolean showScriptFreeForm, boolean showScriptClass, CompilerConfiguration config)
----

This method:

- Takes Groovy source code as input

- Compiles it to a specified phase (e.g., SEMANTIC_ANALYSIS, INSTRUCTION_SELECTION)

- Converts the AST back into Groovy-like source code for inspection

üñ•Ô∏è Command-Line Use
You can also run it from the command line to compile a Groovy file and print the resulting source:

bash
[source,bash]
----
java groovy.console.ui.AstNodeToScriptAdapter [filename] [compilePhase]`
----

üß™ Example Use Case

Say you're using the @Immutable annotation and want to see what boilerplate code Groovy generates‚Äîthis class lets you peek under the hood and see the transformed code.
____


This conversation with Copilot was useful. I got an idea that I should invent a utility that applies the `AstNodeToScriptAdapter`  to a single source code with a `@Immutable` annotation for every value of Compilation Phases to unparse the transient AST objects into human-readable *.groovy source codes.

So I developed the `com.kazurayam.groovy.CompilePhasesDiffer`.
